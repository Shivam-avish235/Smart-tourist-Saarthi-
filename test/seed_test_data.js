import mongoose from 'mongoose';
import dotenv from 'dotenv';
import bcrypt from 'bcryptjs';
import fs from 'fs';

// Load environment variables
dotenv.config();

// Import models
import Tourist from './src/models/Tourist.js';
import Incident from './src/models/Incident.js';

const seedTestData = async () => {
    try {
        console.log('ğŸ”— Connecting to MongoDB...');

        // Connect to MongoDB
        await mongoose.connect(process.env.MONGO_URI || 'mongodb://127.0.0.1:27017/smart_tourist');
        console.log('âœ… Connected to MongoDB');

        // Clear existing test data
        console.log('ğŸ§¹ Clearing existing test data...');
        await Tourist.deleteMany({ email: { $regex: /^test/ } });
        await Incident.deleteMany({});
        console.log('âœ… Test data cleared');

        // Read test data
        const testData = JSON.parse(fs.readFileSync('./backend_test_data.json', 'utf8'));

        // Seed tourists
        console.log('ğŸ‘¥ Seeding tourists...');
        const tourists = [];

        for (const touristData of testData.tourists) {
            // Hash password
            const salt = await bcrypt.genSalt(12);
            const hashedPassword = await bcrypt.hash(touristData.password, salt);

            const tourist = new Tourist({
                ...touristData,
                password: hashedPassword,
                lastActiveAt: new Date(),
                createdAt: new Date()
            });

            await tourist.save();
            tourists.push(tourist);
            console.log(`   âœ… Created tourist: ${tourist.personalInfo.firstName} ${tourist.personalInfo.lastName}`);
        }

        // Seed incidents  
        console.log('ğŸš¨ Seeding incidents...');
        for (const incidentData of testData.incidents) {
            // Find tourist by email
            const tourist = tourists.find(t => t.email === incidentData.touristEmail);
            if (tourist) {
                const incident = new Incident({
                    ...incidentData,
                    touristId: tourist._id,
                    reportedBy: 'System',
                    autoGenerated: true
                });

                await incident.save();
                console.log(`   âœ… Created incident: ${incident.type} for ${tourist.personalInfo.firstName}`);
            }
        }

        console.log('\nğŸ¯ TEST DATA SEEDING COMPLETED!');
        console.log('=' * 40);
        console.log(`ğŸ‘¥ Tourists seeded: ${tourists.length}`);
        console.log(`ğŸš¨ Incidents seeded: ${testData.incidents.length}`);

        console.log('\nğŸ§ª TEST CREDENTIALS:');
        console.log('Email: test1@example.com | Password: password123');
        console.log('Email: test2@example.com | Password: password123');  
        console.log('Email: test3@example.com | Password: password123');
        console.log('\nAdmin: username=admin | password=admin123');

    } catch (error) {
        console.error('âŒ Error seeding test data:', error);
    } finally {
        await mongoose.connection.close();
        console.log('ğŸ“ Database connection closed');
        process.exit(0);
    }
};

// Run seeder
seedTestData();
